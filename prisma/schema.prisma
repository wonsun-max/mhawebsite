generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ Enums ============

enum UserRole {
  STUDENT      // 학생
  TEACHER      // 선생님
  ADMIN        // 행정실
  PARENT       // 학부모
  GUEST        // 외부인
}

enum UserStatus {
  PENDING      // 관리자 승인 대기
  ACTIVE       // 활성화
  SUSPENDED    // 정지
  INACTIVE     // 비활성화
}

enum BoardCategory {
  ANNOUNCEMENT  // 공지사항
  GALLERY       // 학교앨범
  RESOURCES     // 자료실
  FREE_BOARD    // 자유게시판
  MEAL          // 급식안내
  SUPPORT       // 후원안내
}

enum MediaType {
  IMAGE
  VIDEO
  DOCUMENT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  APPROVE_USER
  SUSPEND_USER
  ROLE_CHANGE
}

enum ReportReason {
  SPAM           // 스팸
  INAPPROPRIATE  // 부적절한 내용
  HARASSMENT     // 괴롭힘
  FALSE_INFO     // 허위 정보
  OTHER          // 기타
}

enum ReactionType {
  LIKE   // 좋아요
  HEART  // 하트 (future expansion)
}

// ============ Custom Authentication Models ============

model User {
  id            String    @id @default(cuid())
  username      String?   @unique  // 로그인 ID (optional for migration)
  email         String    @unique
  passwordHash  String?   // bcrypt/argon2 해시 (optional for migration)

  name          String?
  koreanName    String?
  image         String?
  birthdate     DateTime?
  gender        String?
  age           Int?       // Age (calculated or entered)
  grade         Int?       // For students
  studentName   String?    // For parents - their child's name
  nickname      String?    // User-chosen nickname for anonymous posting

  role          UserRole    @default(STUDENT)
  status        UserStatus  @default(ACTIVE)  // Changed default for existing users

  emailVerified Boolean     @default(false)
  verifiedAt    DateTime?

  lastLoginAt   DateTime?
  loginAttempts Int         @default(0)
  lockedUntil   DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  approvedAt    DateTime?
  approvedBy    String?   // Admin user ID who approved

  refreshTokens RefreshToken[]
  posts         BoardPost[]
  comments      Comment[]
  auditLogs     AuditLog[]
  reactions     Reaction[]
  reports       PostReport[]
  albums        Album[]

  @@index([email])
  @@index([username])
  @@index([status])
}

// Refresh Token 관리 (30일 TTL)
model RefreshToken {
  id           String   @id @default(cuid())
  tokenHash    String   @unique  // SHA256 해시
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt    DateTime
  createdAt    DateTime @default(now())
  ipAddress    String?
  userAgent    String?

  @@index([userId])
  @@index([expiresAt])
}

// 이메일 인증 코드 (Redis 대체용 - 10분 TTL)
model VerificationCode {
  id         String   @id @default(cuid())
  email      String
  code       String   // 6자리 숫자
  tempKey    String?  @unique  // 인증 후 발급되는 임시 키
  purpose    String   // 'signup' | 'reset_password'

  expiresAt  DateTime
  createdAt  DateTime @default(now())
  verified   Boolean  @default(false)
  verifiedAt DateTime?

  @@index([email])
  @@index([code])
  @@index([expiresAt])
}

// Audit Logs (권한 변경 추적)
model AuditLog {
  id          String      @id @default(cuid())
  action      AuditAction
  actorId     String
  actor       User        @relation(fields: [actorId], references: [id])
  targetId    String?     // 대상 사용자/리소스 ID
  targetType  String?     // 'User' | 'Post' | etc
  reason      String?     @db.Text
  metadata    Json?       // 추가 정보 (이전 값, 새 값 등)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  @@index([actorId])
  @@index([targetId])
  @@index([createdAt])
}

// ============ Board & Content Models ============

model BoardPost {
  id          String        @id @default(cuid())
  title       String
  content     String        @db.Text
  category    BoardCategory
  anonymousNickname String?   // Nickname used if posted anonymously
  isPinned    Boolean       @default(false)
  views       Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  author      User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId    String

  comments    Comment[]
  media       MediaFile[]
  reactions   Reaction[]
  reports     PostReport[]
  editHistory PostHistory[]

  @@index([category])
  @@index([createdAt])
  @@index([isPinned])
}

model Comment {
  id        String   @id @default(cuid())
  text      String   @db.Text
  anonymousNickname String?   // Nickname for anonymous comments
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  post      BoardPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String

  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId  String

  // Nested comments support
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  parentId  String?
  replies   Comment[] @relation("CommentReplies")

  reactions Reaction[]

  @@index([postId])
  @@index([parentId])
}

model MediaFile {
  id          String    @id @default(cuid())
  filename    String
  originalName String
  fileUrl     String
  fileSize    Int
  mimeType    String
  mediaType   MediaType
  createdAt   DateTime  @default(now())

  post        BoardPost? @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId      String?

  @@index([postId])
}

// ============ Reaction System ============

model Reaction {
  id        String   @id @default(cuid())
  type      ReactionType @default(LIKE)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  // Either post or comment, not both
  post      BoardPost? @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String?

  comment   Comment?  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId String?

  @@unique([userId, postId])     // User can only react once per post
  @@unique([userId, commentId])  // User can only react once per comment
  @@index([postId])
  @@index([commentId])
}

// ============ Report System ============

model PostReport {
  id        String       @id @default(cuid())
  reason    ReportReason
  details   String?      @db.Text
  status    String       @default("PENDING") // PENDING, REVIEWED, RESOLVED
  createdAt DateTime     @default(now())
  reviewedAt DateTime?
  reviewedBy String?      // Admin who reviewed

  post      BoardPost    @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    String

  reporter  User         @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  reporterId String

  @@index([postId])
  @@index([reporterId])
  @@index([status])
}

// ============ Edit History ============

model PostHistory {
  id            String   @id @default(cuid())
  previousTitle String
  previousContent String @db.Text
  editedAt      DateTime @default(now())

  post          BoardPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId        String

  @@index([postId])
  @@index([editedAt])
}

// ============ MK Missionary Models ============

model MKMissionary {
  id          String   @id @default(cuid())
  name        String
  koreanName  String?
  role        String
  description String   @db.Text
  imageUrl    String?
  email       String?
  phone       String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
  @@index([order])
}

// ============ Meal Plan Model ============

model MealPlan {
  id          String   @id @default(cuid())
  date        DateTime
  breakfast   String?  @db.Text
  lunch       String?  @db.Text
  snack       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([date])
  @@index([date])
}

// ============ School Album Model ============

model Album {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  images      String[] // Array of image file paths
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  authorId    String

  @@index([createdAt])
  @@index([authorId])
}

// ============ Inquiry System ============

model Inquiry {
  id        String   @id @default(cuid())
  name      String
  email     String
  phone     String?
  kakaoId   String?
  message   String   @db.Text
  status    String   @default("UNREAD") // UNREAD, READ, REPLIED
  category  String   @default("GENERAL") // GENERAL, ADMISSION
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([category])
  @@index([createdAt])
}

// ============ Calendar Event Model ============

model CalendarEvent {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  date        DateTime
  endDate     DateTime?
  category    String   @default("event")  // "event", "holiday", "exam", "meeting"
  
  semesterId  String?
  semester    Semester? @relation(fields: [semesterId], references: [id])
  
  isAllDay    Boolean  @default(true)
  color       String?  // Optional color for UI
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([date])
  @@index([semesterId])
  @@index([category])
  @@index([order])
}

model Semester {
  id          String   @id // 's1', 's2'
  name        String
  startDate   DateTime?
  endDate     DateTime?
  image       String?
  pdf         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  events      CalendarEvent[]
}
